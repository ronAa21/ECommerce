
@{
    ViewBag.Title = "Checked";
}
<style>
    /* General */
    * {
        font-family: sans-serif;
    }

    h1, h2, h3, h4, h5, p {
        margin: 0;
    }

    body {
        background-color: rgb(203, 203, 203);
    }

    /* Main Container */
    .main-container, .product-container {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .check-container, .product-checked {
        background-color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: space-between;
    }

    .wrapper {
        display: flex;
        gap: 32px;
    }

    #product-title {
        margin-left: 55px;
    }

    .icon-img {
        width: 100px;
    }

    .img-name {
        align-self: center;
    }

    .icon-wrap {
        display: flex;
        gap: 30px;
    }

    .product-wrap {
        display: flex;
        gap: 80px;
    }

    .prd-details {
        align-self: center;
        gap: 50px;
    }

    .prd-action {
        align-self: center;
        background: none;
        border: none;
        color: red;
    }

    /* Check out section */

    .checkout-section {
        display: flex;
        background-color: white;
        justify-content: space-between;
        padding: 30px;
        border-radius: 20px 20px 0 0;
        position: fixed;
        bottom: 0;
        left: 20px;
        width: 90%;
    }

    .check-wrap {
        display: flex;
        gap: 15px;
    }

    .check-amount, .total-display {
        align-self: center;
    }

    #checkout {
        background-color: forestgreen;
        border: none;
        border-radius: 10px;
        color: white;
        padding: 15px;
        cursor: pointer;
    }

    .total-display {
        font-weight: 200;
        color: forestgreen;
    }

    /* check container */
    .checkers {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999999;
        background-color: rgba(0,0,0,0.4);
    }

    .checked-out {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        background-color: rgba(0,0,0,0.7);
        padding: 10px;
        border-radius: 15px;
        width: 40%;
    }

    #check-icon {
        width: 100px;
    }

    .added-text {
        font-weight: 300;
        color: white;
    }

    /* Deletion Modal */
    .delete-modal {
        background-color: white;
        border-radius: 15px;
        padding: 25px;
        width: 40%;
        height: 30%;
        display: flex;
        flex-direction: column;
        gap: 25px;
        justify-content: center;
        align-content: center;
    }

    .btn-wrap {
        display: flex;
        justify-content: space-around;
        gap: 20px;
    }

    .btn-action {
        border: none;
        padding: 10px;
        border-radius: 10px;
        width: 30%;
    }
</style>

<main>
    <div class="main-container">
        <div id="check-header" class="check-container">
            <h3 id="product-title">Products</h3>
            <div class="wrapper">
                <h3 class="head-h3">Category</h3>
                <h3 class="head-h3">Price</h3>
                <h3 class="head-h3">Quantity</h3>
                <h3 class="head-h3">Total Price</h3>
                <h3 class="head-h3">Action</h3>
            </div>
        </div>
    </div>

    <div class="product-container">
        <!-- place the product container here -->
    </div>
</main>

<div class="checkout-section">
    <div class="check-wrap">
        <input type="checkbox" class="select-all" />

        <!-- display this dynamically -->
        <p class="check-amount">Select All(<span style="font-weight: 500">0</span>)</p>
        <button class="prd-action" id="cancel">Cancel</button>
    </div>
    <div class="check-wrap">
        <p class="check-amount">Total:</p>

        <!-- Display this dynamically -->
        <h2 class="total-display">$00.00</h2>
        <button id="checkout">Checkout</button>
    </div>
</div>

<!-- Check-container -->
<div class="checkers" style="display: none">
    <div class="checked-out">
        <img src="~/Content/checked.png" id="check-icon" />
        <h3 class="added-text">Checked out</h3>
    </div>
</div>

<!-- delete product confirmation -->
<div class="checkers" id="deletion-modal" style="display:none">
    <div class="delete-modal">
        <h2 class="delete-text">Are you sure you want to delete this product?</h2>
        <div class="btn-wrap">
            <button class="btn-action" id="not-delete">no</button>
            <button class="btn-action" id="confirm-delete">yes</button>
        </div>
    </div>
</div>

<style>

</style>

<script>

    // Replace this with the localStorage
    let checkedProducts = JSON.parse(localStorage.getItem("checkedProducts")) || [];

    // call the product-checked container
    let mainContainer = document.querySelector(".main-container");
    let productChecked = document.getElementById("product-checked");
    let productContainer = document.querySelector(".product-container");

    // deletion modal
    let deletionModal = document.getElementById("deletion-modal");

    productDisplay(checkedProducts);

    function productDisplay(prod) {
        productContainer.innerHTML = "";
        prod.forEach((pr, i) => {
            // product Container
            let productChecked = document.createElement("div");
            productChecked.classList.add("check-container", "product-checked");

            // icon wrap
            let iconWrap = document.createElement("div");
            iconWrap.className = "icon-wrap";

            let checkOut = document.createElement("input");
            checkOut.type = "checkbox";
            checkOut.className = "check-out";
            checkOut.dataset.index = i

            let iconImg = document.createElement("img");
            iconImg.className = "icon-img";
            iconImg.src = pr.img;

            let imgName = document.createElement("h3");
            imgName.className = "img-name";
            imgName.textContent = pr.name;

            // Product wrap
            let productWrap = document.createElement("div");
            productWrap.className = "product-wrap";

            let rootDetails = document.createElement("h3");
            rootDetails.className = "prd-details";
            rootDetails.textContent = pr.type;

            let priceDetails = document.createElement("h3");
            priceDetails.className = "prd-details";
            priceDetails.textContent = pr.price;

            let qtyDetails = document.createElement("h3");
            qtyDetails.className = "prd-details";
            qtyDetails.textContent = pr.amount;

            let totalDetails = document.createElement("h3");
            totalDetails.className = "prd-details";

             totalDetails.textContent = pr.totalPrice;

            let prdAction = document.createElement("button");
            prdAction.className = "prd-action";
            prdAction.textContent = "Delete";

            // appending
            iconWrap.appendChild(checkOut);
            iconWrap.appendChild(iconImg);
            iconWrap.appendChild(imgName);

            productWrap.appendChild(rootDetails);
            productWrap.appendChild(priceDetails);
            productWrap.appendChild(qtyDetails);
            productWrap.appendChild(totalDetails);
            productWrap.appendChild(prdAction);

            productChecked.appendChild(iconWrap);
            productChecked.appendChild(productWrap);

            productContainer.appendChild(productChecked);

            // calculate every checked box
            checkOut.addEventListener("change", () => {
                updateCheckedCount();
                totals();
            });

            // delete listener
            prdAction.addEventListener("click", () => {
                deletionModal.style.display = "flex";

                // one-time click for modal buttons
                deletionModal.onclick = (e) => {
                    if (e.target.id === "confirm-delete") {
                        deletionModal.style.display = "none";
                        deleteItem(i);
                    } else if (e.target.id === "not-delete") {
                        deletionModal.style.display = "none";
                    }
                };
            });
        });
    }

    // After creating products
    let checkboxes = document.querySelectorAll(".check-out");
    let selectAll = document.querySelector(".select-all");
    let checkCountDisplay = document.querySelector(".check-amount span");

    // Function to update checked count
    function updateCheckedCount() {
        let checkboxes = document.querySelectorAll(".check-out");
        let checkedCount = document.querySelectorAll(".check-out:checked").length;
        checkCountDisplay.textContent = checkedCount;

        // If all are checked, also check the "select all"
        selectAll.checked = checkedCount === checkboxes.length;
    }

    document.getElementById("cancel").addEventListener("click", function () {
        let checkboxes = document.querySelectorAll(".check-out");
        checkCountDisplay.textContent = 0;

        // uncheck all checkbox
        checkboxes.forEach(box => {
            box.checked = false;
        });

        // Uncheck the select all checkbox too
        selectAll.checked = false;

        totals();
    })

    // Add event listener to each product checkbox
    checkboxes.forEach(box => {
        box.addEventListener("change", updateCheckedCount);
    });

    // Select All functionality
    selectAll.addEventListener("change", function () {
        let checkboxes = document.querySelectorAll(".check-out");
        checkboxes.forEach(box => {
            box.checked = selectAll.checked;
        });
        updateCheckedCount();
        totals();
    });

    function totals() {
        let checkedBoxes = document.querySelectorAll(".check-out:checked");
        let totalDisplay = document.querySelector(".total-display");

        let total = Array.from(checkedBoxes).reduce((acc, box) => {
            let index = Number(box.dataset.index);
            let item = checkedProducts[index];
            if (!item) return acc; // skip if undefined
            return acc + Number(item.totalPrice || item.price || 0);
        }, 0);

        totalDisplay.textContent = `$${total.toFixed(2)}`;
    }

    // Initialize count on load
    updateCheckedCount();

    document.getElementById("checkout").addEventListener("click", function () {
        checkoutAction();
    })

    function checkoutAction() {
        let checkedBoxes = document.querySelectorAll(".check-out:checked");
        let checkAmount = document.querySelector(".check-amount span");
        let checkers = document.querySelector(".checkers");

        // remove checked items
        checkedProducts = checkedProducts.filter((_, i) =>
            !Array.from(checkedBoxes).some(box => Number(box.dataset.index) === i)
        );

        localStorage.setItem("checkedProducts", JSON.stringify(checkedProducts));
        productDisplay(checkedProducts);
        updateCheckedCount();
        totals();

        checkers.style.display = "flex";
        setTimeout(() => {
            checkers.style.display = "none";
        }, 2000); 
        
        checkAmount.textContent = 0;
        document.querySelector(".total-display").textContent = "$00.00";
        document.querySelector(".select-all").checked = false;

    }

    // deletion function
    function deleteItem(index) {
        checkedProducts.splice(index, 1);

        localStorage.setItem("checkedProducts", JSON.stringify(checkedProducts));

        productDisplay(checkedProducts);
        updateCheckedCount();
        totals();
    }

</script>

